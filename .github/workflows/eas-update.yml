name: EAS Update

on:
  workflow_call:
    inputs:
      release_tag:
        description: "Release tag for the update message"
        type: string
        required: false
      channel:
        description: "EAS update channel"
        type: string
        required: false
        default: "preview"
  push:
    branches: ['main']
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag for the update message"
        type: string
        required: false
      channel:
        description: "EAS update channel"
        type: choice
        options:
          - preview
          - production
        default: "preview"

jobs:
  publish-eas-update:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mensasverige
    env:
      DEFAULT_CHANNEL: preview
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
  
      - name: Set update message
        id: update-message
        run: |
          if [[ "${{ github.event_name }}" == "workflow_call" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ inputs.release_tag }}" ]]; then
              echo "message=Release ${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
            else
              echo "message=Update - $(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
            fi
            echo "channel=${{ inputs.channel }}" >> $GITHUB_OUTPUT
          else
            echo "message=Update from main branch - $(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
            echo "channel=${{ env.DEFAULT_CHANNEL }}" >> $GITHUB_OUTPUT
          fi
        
      - name: EAS Update
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Publishing update for all platforms..."
          npx eas update --channel ${{ steps.update-message.outputs.channel }} --message "${{ steps.update-message.outputs.message }}"