name: EAS Update

on:
  workflow_call:
    inputs:
      release_tag:
        description: "Release tag for the update message"
        type: string
        required: false
      environment:
        description: "EAS update environment"
        type: string
        required: false
        default: "preview"
  push:
    branches: ['main']
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag for the update message"
        type: string
        required: false
      environment:
        description: "EAS update environment"
        type: choice
        options:
          - preview
          - production
        default: "preview"

jobs:
  publish-eas-update:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mensasverige
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          yarn 
          
      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
  
      - name: Set update message
        id: update-message
        run: |
          if [[ "${{ github.event_name }}" == "workflow_call" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ inputs.release_tag }}" ]]; then
              echo "message=Release ${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
            else
              echo "message=Update - $(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
            fi
          else
            echo "message=Update from main branch - $(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          fi
        
      - name: EAS Update
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_ENV: ${{ inputs.environment || 'preview' }}
        run: |
          echo "Publishing update for all platforms..."
          echo "Environment: ${{ inputs.environment || 'preview' }}"
          echo "APP_ENV: ${APP_ENV}"
          npx eas update --channel ${{ inputs.environment || 'preview' }} --message "${{ steps.update-message.outputs.message }}"