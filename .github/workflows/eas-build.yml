name: Local Build

on:
  workflow_call:
    inputs:
      profile:
        description: "Build profile"
        type: string
        required: false
        default: "preview"
      platform:
        description: "Platform to build for"
        type: string
        required: false
        default: "all"
      clear_cache:
        description: "Clear build cache"
        type: boolean
        required: false
        default: false
  workflow_dispatch:
    inputs:
      profile:
        description: "Build profile"
        type: choice
        options:
          - development
          - preview
          - production
        default: "preview"
      platform:
        description: "Platform to build for"
        type: choice
        options:
          - all
          - android
          - ios
        default: "all"
      clear_cache:
        description: "Clear build cache"
        type: boolean
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mensasverige
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          yarn 
          
      - name: Setup Expo CLI
        run: |
          npm install -g @expo/cli

      - name: Clear cache if requested
        if: ${{ inputs.clear_cache == true }}
        run: |
          yarn cache clean
          npx expo install --fix

      - name: Set build parameters
        id: build-params
        run: |
          PROFILE="${{ inputs.profile || 'preview' }}"
          PLATFORM="${{ inputs.platform || 'all' }}"
          CLEAR_CACHE="${{ inputs.clear_cache || 'false' }}"
          
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "clear_cache=$CLEAR_CACHE" >> $GITHUB_OUTPUT
          
          echo "Building profile: $PROFILE"
          echo "Platform: $PLATFORM"
          echo "Clear cache: $CLEAR_CACHE"

      - name: Pre-build Android
        if: ${{ steps.build-params.outputs.platform == 'android' || steps.build-params.outputs.platform == 'all' }}
        run: |
          npx expo prebuild --platform android --clear

      - name: Build Android APK
        if: ${{ steps.build-params.outputs.platform == 'android' || steps.build-params.outputs.platform == 'all' }}
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Pre-build iOS
        if: ${{ steps.build-params.outputs.platform == 'ios' || steps.build-params.outputs.platform == 'all' }}
        run: |
          npx expo prebuild --platform ios --clear

      - name: Build iOS
        if: ${{ steps.build-params.outputs.platform == 'ios' || steps.build-params.outputs.platform == 'all' }}
        run: |
          echo "iOS builds require macOS runner - skipping for now"
          echo "To build iOS locally, use: npx expo run:ios --configuration Release"

      - name: Upload Android APK
        if: ${{ steps.build-params.outputs.platform == 'android' || steps.build-params.outputs.platform == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.build-params.outputs.profile }}
          path: mensasverige/android/app/build/outputs/apk/release/*.apk

      - name: Build Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: ${{ steps.build-params.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ steps.build-params.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Clear Cache**: ${{ steps.build-params.outputs.clear_cache }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY